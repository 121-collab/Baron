# Baron et al. 2016 pancreas scRNA‑seq — combined R pipeline
  
 0. 全局设置与公共函数
############################################################
# Baron et al., 2016 — Human & Mouse Pancreas scRNA-seq
# Combined script: build Seurat + Fig1–4 (human & mouse)
############################################################
## ------------ 0.1 路径与参数 ------------
# 修改为GSE84133_RAW 目录
BASE_DIR <- "/data/projects/genebiotec_wushujun/Baron_GSE84133/GSE84133_RAW"
# 保存结果的子目录
RESULTS_HUMAN <- file.path(BASE_DIR, "results_paper")
RESULTS_MOUSE <- file.path(BASE_DIR, "results_mouse_paper")
dir.create(RESULTS_HUMAN, showWarnings = FALSE, recursive = TRUE)
dir.create(RESULTS_MOUSE, showWarnings = FALSE, recursive = TRUE)
SEED <- 123
set.seed(SEED)
# Seurat / PCA / 聚类相关参数（与你服务器版一致或相近）
N_HVG  <- 2000
PCS    <- 30
DIMS   <- 1:15
RES    <- 0.5
QC_MIN_GENES <- 500
QC_MAX_GENES <- 6000
QC_MAX_MT    <- 0.10
QC_MAD_CLIP  <- TRUE
## ------------ 0.2 加载 R 包 ------------
suppressPackageStartupMessages({
  library(data.table)
  library(Matrix)
  library(Seurat)
  library(ggplot2)
  library(patchwork)
  library(dplyr)
  library(pheatmap)
  library(tidyr)
})
## ------------ 0.3 工具函数（4 个脚本公用） ------------
# 兼容 Seurat v4/v5：统一获取 counts / data
get_counts <- function(obj, assay = DefaultAssay(obj)) {
  a <- obj[[assay]]
  if ("layers" %in% slotNames(a)) {
    GetAssayData(obj, assay = assay, layer = "counts")
  } else {
    GetAssayData(obj, assay = assay, slot  = "counts")
  }
}
get_data <- function(obj, assay = DefaultAssay(obj)) {
  a <- obj[[assay]]
  if ("layers" %in% slotNames(a)) {
    GetAssayData(obj, assay = assay, layer = "data")
  } else {
    GetAssayData(obj, assay = assay, slot  = "data")
  }
}
# 线粒体 / 核糖体基因
mt_genes <- function(genes)  genes[grepl("^MT-|^mt-|^mt\\.", genes)]
rb_genes <- function(genes)  genes[grepl("^RPL|^RPS|^rpl|^rps", genes)]
# MAD 过滤辅助函数
mad_keep <- function(x, k = 3) {
  med <- median(x, na.rm = TRUE)
  md  <- mad(x, constant = 1.4826, na.rm = TRUE)
  x >= (med - k * md) & x <= (med + k * md)
}
# 从文件名提取 sample / donor ID
get_sample_id <- function(file, species = c("human","mouse")) {
  species <- match.arg(species)
  bn <- basename(file)
  m <- regexpr(paste0(species, "[0-9]+"), bn, ignore.case = TRUE)
  if (m > 0) {
    id <- substr(bn, m, m + attr(m, "match.length") - 1)
  } else {
    id <- strsplit(bn, "_")[[1]][1]
  }
  id <- gsub("human","H",id,ignore.case = TRUE)
  id <- gsub("mouse","M",id,ignore.case = TRUE)
  id
}
# 读取 Baron csv.gz（每个 donor 一个文件）
read_baron_file <- function(file) {
  message("Reading: ", basename(file))
  DT <- data.table::fread(file, header = TRUE, check.names = FALSE, data.table = TRUE)
  nm_raw <- names(DT)
  nm_low <- tolower(trimws(nm_raw))
  # 删除完全空的首列
  if (nm_low[1] %in% c("", "v1")) {
    v1 <- DT[[1]]
    if (all(is.na(v1) | v1 == "")) {
      DT <- DT[, -1, with = FALSE]
      nm_raw <- names(DT)
      nm_low <- tolower(trimws(nm_raw))
    }
  }
  # barcode 列
  bcol <- which(nm_low == "barcode")
  if (length(bcol) != 1) {
    stop("未找到唯一 barcode 列：", paste(nm_raw, collapse = ", "))
  }
  barcodes <- as.character(DT[[bcol]])
  keep <- !(is.na(barcodes) | barcodes == "")
  if (any(!keep)) {
    DT <- DT[keep]
    barcodes <- barcodes[keep]
  }
  if (any(duplicated(barcodes))) {
    keep2 <- !duplicated(barcodes)
    DT <- DT[keep2]
    barcodes <- barcodes[keep2]
  }
  # 去掉 assigned_cluster 列
  ccol <- which(nm_low == "assigned_cluster")
  drop_idx <- unique(c(bcol, ccol))
  expr_DT <- if (length(drop_idx) > 0) DT[, -drop_idx, with = FALSE] else DT
  # 转数值
  expr_DF <- as.data.frame(lapply(expr_DT, function(x)
    suppressWarnings(as.numeric(as.character(x)))))
  expr_DF[is.na(expr_DF)] <- 0
  nz <- which(colSums(expr_DF) > 0)
  expr_DF <- expr_DF[, nz, drop = FALSE]
  M <- as.matrix(expr_DF)      # 行=细胞  列=基因
  genes <- colnames(M)
  if (is.null(genes)) genes <- paste0("gene_", seq_len(ncol(M)))
  Mt <- t(M)                   # gene × cell
  rownames(Mt) <- make.unique(genes)
  colnames(Mt) <- make.unique(barcodes)
  Matrix(Mt, sparse = TRUE)
}
# 合并重复基因名
aggregate_by_rownames <- function(smat) {
  mt <- as(smat, "dgTMatrix")
  dt <- data.table(
    gene = rownames(smat)[mt@i + 1],
    j    = mt@j + 1,
    x    = mt@x
  )
  dt2 <- dt[, .(x = sum(x)), by = .(gene, j)]
  uniq_genes <- unique(dt2$gene)
  sparseMatrix(
    i = match(dt2$gene, uniq_genes),
    j = dt2$j,
    x = dt2$x,
    dims = c(length(uniq_genes), ncol(smat)),
    dimnames = list(uniq_genes, colnames(smat))
  )
}
# 修正行列名
fix_dimnames <- function(smat) {
  rn <- rownames(smat)
  rn[is.na(rn) | rn == ""] <- paste0("gene_", seq_len(sum(is.na(rn) | rn == "")))
  rownames(smat) <- make.unique(rn)
  cn <- colnames(smat)
  cn[is.na(cn) | cn == ""] <- paste0("cell_", seq_len(sum(is.na(cn) | cn == "")))
  colnames(smat) <- make.unique(cn)
  smat
}
# 基因名匹配（忽略大小写）
match_features <- function(obj, genes) {
  rn   <- rownames(obj)
  rn_l <- tolower(rn)
  g_l  <- tolower(genes)
  idx  <- match(g_l, rn_l)
  found  <- rn[!is.na(idx)]
  missed <- genes[is.na(idx)]
  if (length(missed) > 0) {
    message("以下基因没找到，将忽略：", paste(missed, collapse = ", "))
  }
  found
}
# 统一主题（绘图）
theme_baron <- function(base = 10){
  theme_bw(base_size = base) +
    theme(
      panel.grid      = element_blank(),
      strip.background = element_rect(fill = "grey92", color = NA),
      strip.text      = element_text(face = "bold"),
      plot.title      = element_text(face = "bold", hjust = 0.5, size = base + 2),
      axis.text.x     = element_text(angle = 45, hjust = 1, vjust = 1)
    )
}
```
---
## 1. 建立并注释 Seurat 对象（01\_build\_seurat.R）
这一部分对应你原来的 `01_build_seurat.R`。  
如果 RDS 已存在，则直接读取；否则从 `human*.csv.gz` / `mouse*.csv.gz` 构建、QC、注释并保存。
```r
############################################################
# 1. Build & annotate Seurat objects (human & mouse)
############################################################
human_rds  <- file.path(RESULTS_HUMAN, "Human_seurat_celltyped.rds")
mouse_rds  <- file.path(RESULTS_MOUSE, "Mouse_seurat_celltype.rds")
build_seurat_qc <- function(species = c("human","mouse")) {
  species <- match.arg(species)
  message("====== Building Seurat for ", species, " ======")
  pat <- paste0(species, ".*\\.csv\\.gz$")
  files <- list.files(BASE_DIR, pattern = pat, full.names = TRUE)
  if (length(files) == 0) {
    stop("没有找到 ", pat, "，请确认 GSE84133_RAW 解压路径。")
  }
  mat_list <- list()
  sid_list <- character(0)
  for (f in files) {
    sid <- get_sample_id(f, species)
    mat <- read_baron_file(f)
    colnames(mat) <- paste(sid, colnames(mat), sep = "_")
    mat_list[[length(mat_list) + 1]] <- mat
    sid_list[length(sid_list) + 1]   <- sid
  }
  if (length(mat_list) > 1) {
    g_common <- Reduce(intersect, lapply(mat_list, rownames))
    mat_list <- lapply(mat_list, function(m) m[g_common, , drop = FALSE])
  }
  mat <- do.call(cbind, mat_list)
  mat <- fix_dimnames(aggregate_by_rownames(mat))
  sample_vec <- unlist(mapply(
    FUN   = function(m, sid) rep(sid, ncol(m)),
    m     = mat_list,
    sid   = sid_list,
    SIMPLIFY = FALSE
  ))
  names(sample_vec) <- colnames(mat)
  list(counts = mat, sample = sample_vec)
}
qc_and_make_seurat <- function(counts, sample_vec, species_label) {
  message("====== QC for ", species_label, " ======")
  md <- data.frame(
    row.names = colnames(counts),
    species   = species_label,
    sample    = sample_vec[colnames(counts)],
    stringsAsFactors = FALSE
  )
  obj <- CreateSeuratObject(
    counts = counts,
    project = paste0("Baron_", species_label),
    meta.data = md,
    min.cells = 0,
    min.features = 0
  )
  obj$orig.ident <- obj$sample
  counts <- get_counts(obj)
  genes  <- rownames(counts)
  mt_set <- mt_genes(genes)
  rb_set <- rb_genes(genes)
  nFeature <- Matrix::colSums(counts > 0)
  nCount   <- Matrix::colSums(counts)
  pct_mt   <- if (length(mt_set) > 0) Matrix::colSums(counts[mt_set, , drop = FALSE]) / pmax(nCount, 1) * 100 else rep(0, ncol(counts))
  pct_rb   <- if (length(rb_set) > 0) Matrix::colSums(counts[rb_set, , drop = FALSE]) / pmax(nCount, 1) * 100 else rep(0, ncol(counts))
  obj$nFeature_RNA <- nFeature
  obj$nCount_RNA   <- nCount
  obj$percent.mt   <- pct_mt
  obj$percent.ribo <- pct_rb
  keep1 <- (nFeature >= QC_MIN_GENES) &
           (nFeature <= QC_MAX_GENES) &
           (pct_mt  <= QC_MAX_MT * 100)
  if (QC_MAD_CLIP) {
    keep2 <- rep(TRUE, ncol(obj))
    for (id in unique(obj$sample)) {
      idx <- which(obj$sample == id)
      keep2[idx] <- mad_keep(nFeature[idx]) &
                    mad_keep(nCount[idx]) &
                    mad_keep(pct_mt[idx])
    }
    keep <- keep1 & keep2
  } else {
    keep <- keep1
  }
  message("Cells before QC: ", ncol(obj),
          " | after QC: ", sum(keep))
  obj <- subset(obj, cells = colnames(obj)[keep])
  counts2 <- get_counts(obj)
  keep_genes <- Matrix::rowSums(counts2 > 0) >= 3
  obj <- obj[keep_genes, ]
  obj <- NormalizeData(obj, verbose = FALSE)
  obj <- FindVariableFeatures(obj, nfeatures = N_HVG, verbose = FALSE)
  obj <- ScaleData(obj, verbose = FALSE)
  obj <- RunPCA(obj, npcs = PCS, verbose = FALSE)
  obj <- FindNeighbors(obj, dims = DIMS)
  obj <- FindClusters(obj, resolution = RES)
  obj <- RunUMAP(obj, dims = DIMS, verbose = FALSE)
  obj <- RunTSNE(obj, dims = DIMS, check_duplicates = FALSE)
  obj
}
# marker 列表（人 & 鼠共用）
pancreas_markers <- list(
  Alpha      = c("GCG","Gcg"),
  Beta       = c("INS","Ins1","Ins2"),
  Delta      = c("SST","Sst"),
  PP         = c("PPY","Ppy"),
  Acinar     = c("PRSS1","CPA1","Prss1","Cpa1"),
  Ductal     = c("KRT19","MUC1","CFTR","Krt19","Muc1","Cftr"),
  Endothelial= c("PECAM1","VWF","Pecam1","Vwf"),
  Stellate   = c("COL1A1","RGS5","Col1a1","Rgs5"),
  Immune     = c("PTPRC","LYZ","Ptprc","Lyz2")
)
annotate_pancreas <- function(obj, marker_list, slot_name = "celltype_major") {
  scored_lists <- lapply(marker_list, function(gs) match_features(obj, gs))
  keep <- vapply(scored_lists, length, integer(1)) > 0
  scored_lists <- scored_lists[keep]
  if (length(scored_lists) == 0) stop("在此对象中 marker 都匹配不到。")
  obj <- AddModuleScore(obj, features = scored_lists,
                        name = paste0(slot_name, "_score"))
  score_cols <- grep(paste0("^", slot_name, "_score"), colnames(obj@meta.data), value = TRUE)
  score_mat  <- as.matrix(obj@meta.data[, score_cols, drop = FALSE])
  max_idx  <- apply(score_mat, 1, which.max)
  ct_names <- names(scored_lists)[max_idx]
  max_val  <- apply(score_mat, 1, max)
  ct_names[max_val < 0] <- "Unknown"
  obj[[slot_name]] <- factor(ct_names)
  obj
}
# ===== 实际构建 / 读取 =====
human <- NULL
mouse <- NULL
if (file.exists(human_rds)) {
  message(">>> 读取 Human Seurat 对象： ", human_rds)
  human <- readRDS(human_rds)
} else {
  h_raw <- build_seurat_qc("human")
  human <- qc_and_make_seurat(h_raw$counts, h_raw$sample, "human")
  human <- annotate_pancreas(human, pancreas_markers, slot_name = "celltype_major")
  human$celltype_final <- human$celltype_major
  saveRDS(human, human_rds)
}
if (file.exists(mouse_rds)) {
  message(">>> 读取 Mouse Seurat 对象： ", mouse_rds)
  mouse <- readRDS(mouse_rds)
} else {
  m_raw <- build_seurat_qc("mouse")
  mouse <- qc_and_make_seurat(m_raw$counts, m_raw$sample, "mouse")
  mouse <- annotate_pancreas(mouse, pancreas_markers, slot_name = "celltype_major")
  mouse$celltype_final <- mouse$celltype_major
  saveRDS(mouse, mouse_rds)
}
# 统一 celltype 顺序
ct_order <- c("Alpha","Beta","Delta","PP","Ductal","Acinar",
              "Endothelial","Stellate","Immune","Unknown")
if (!is.null(human)) {
  human$celltype_final <- factor(as.character(human$celltype_final), levels = ct_order)
}
if (!is.null(mouse)) {
  mouse$celltype_final <- factor(as.character(mouse$celltype_final), levels = ct_order)
}
```
---
## 2. Fig1：marker DotPlot 与 Top markers 热图（02\_fig1\_markers.R）
这一部分对应你原来的 **Fig1**：  
- Human / Mouse UMAP / tSNE by `celltype_final`  
- canonical marker DotPlot  
- 每个 celltype 的 Top markers 热图  
```r
############################################################
# 2. Fig1 — cell type markers (UMAP / tSNE / DotPlot / heatmap)
############################################################
# ---- 2.1 Human UMAP / tSNE ----
if (!is.null(human)) {
  pdf(file.path(RESULTS_HUMAN, "Human_UMAP_celltype_paper.pdf"),
      width = 6, height = 5)
  print(
    DimPlot(human, group.by = "celltype_final",
            reduction = "umap", label = TRUE, repel = TRUE,
            label.size = 3, pt.size = 0.25) +
      ggtitle("Human — UMAP by cell type") + theme_baron()
  )
  dev.off()
  pdf(file.path(RESULTS_HUMAN, "Human_tSNE_celltype_paper.pdf"),
      width = 6, height = 5)
  print(
    DimPlot(human, group.by = "celltype_final",
            reduction = "tsne", label = TRUE, repel = TRUE,
            label.size = 3, pt.size = 0.25) +
      ggtitle("Human — tSNE by cell type") + theme_baron()
  )
  dev.off()
}
# ---- 2.2 Mouse UMAP / tSNE ----
if (!is.null(mouse)) {
  pdf(file.path(RESULTS_MOUSE, "Mouse_UMAP_celltype_paper.pdf"),
      width = 6, height = 5)
  print(
    DimPlot(mouse, group.by = "celltype_final",
            reduction = "umap", label = TRUE, repel = TRUE,
            label.size = 3, pt.size = 0.25) +
      ggtitle("Mouse — UMAP by cell type") + theme_baron()
  )
  dev.off()
  pdf(file.path(RESULTS_MOUSE, "Mouse_tSNE_celltype_paper.pdf"),
      width = 6, height = 5)
  print(
    DimPlot(mouse, group.by = "celltype_final",
            reduction = "tsne", label = TRUE, repel = TRUE,
            label.size = 3, pt.size = 0.25) +
      ggtitle("Mouse — tSNE by cell type") + theme_baron()
  )
  dev.off()
}
# ---- 2.3 DotPlot（Fig1B/C 风格） ----
genes_h_panel <- c(
  "INS","GCG","SST","PPY",         # endocrine
  "KRT19","MUC1","CFTR",           # ductal
  "PRSS1","CPA1",                  # acinar
  "PECAM1","VWF",                  # endothelial
  "COL1A1","RGS5",                 # stellate
  "PTPRC","LYZ"                    # immune
)
if (!is.null(human)) {
  feat_h <- match_features(human, genes_h_panel)
  pdf(file.path(RESULTS_HUMAN, "Human_Fig1B_like_heatmap.pdf"),
      width = 8, height = 4)
  print(
    DotPlot(human, features = feat_h, group.by = "celltype_final",
            dot.scale = 5, cols = c("grey90","dodgerblue4"),
            col.min = 0, col.max = 2) +
      RotatedAxis() +
      ggtitle("Human — canonical markers by cell type") +
      theme_baron()
  )
  dev.off()
}
if (!is.null(mouse)) {
  genes_m_panel <- c("Ins1","Ins2","Gcg","Sst","Ppy",
                     "Krt19","Muc1","Cftr",
                     "Prss1","Cpa1",
                     "Pecam1","Vwf",
                     "Col1a1","Rgs5",
                     "Ptprc","Lyz2")
  feat_m <- match_features(mouse, genes_m_panel)
  pdf(file.path(RESULTS_MOUSE, "Mouse_Fig1C_like_heatmap.pdf"),
      width = 8, height = 4)
  print(
    DotPlot(mouse, features = feat_m, group.by = "celltype_final",
            dot.scale = 5, cols = c("grey90","dodgerblue4"),
            col.min = 0, col.max = 2) +
      RotatedAxis() +
      ggtitle("Mouse — canonical markers by cell type") +
      theme_baron()
  )
  dev.off()
}
# ---- 2.4 Top markers 热图 ----
if (!is.null(human)) {
  Idents(human) <- human$celltype_final
  markers_h <- FindAllMarkers(human, only.pos = TRUE,
                              logfc.threshold = 0.25,
                              min.pct = 0.25)
  write.csv(markers_h,
            file.path(RESULTS_HUMAN, "Markers_Human_byCelltype.csv"),
            row.names = FALSE)
  topN <- 5
  top_h <- markers_h %>% group_by(cluster) %>% top_n(n = topN, wt = avg_log2FC)
  genes_h <- unique(top_h$gene)
  human <- ScaleData(human, features = genes_h, verbose = FALSE)
  pdf(file.path(RESULTS_HUMAN, "Human_TopMarkers_Heatmap_paper.pdf"),
      width = 8, height = 6)
  print(
    DoHeatmap(human, features = genes_h, group.by = "celltype_final",
              slot = "scale.data", raster = TRUE, label = FALSE) +
      ggtitle(paste0("Human — Top", topN, " markers per cell type")) +
      theme_baron()
  )
  dev.off()
}
if (!is.null(mouse)) {
  Idents(mouse) <- mouse$celltype_final
  markers_m <- FindAllMarkers(mouse, only.pos = TRUE,
                              logfc.threshold = 0.25,
                              min.pct = 0.25)
  write.csv(markers_m,
            file.path(RESULTS_MOUSE, "Markers_Mouse_byCelltype.csv"),
            row.names = FALSE)

  topN <- 5
  top_m <- markers_m %>% group_by(cluster) %>% top_n(n = topN, wt = avg_log2FC)
  genes_m <- unique(top_m$gene)

  mouse <- ScaleData(mouse, features = genes_m, verbose = FALSE)
  pdf(file.path(RESULTS_MOUSE, "Mouse_TopMarkers_Heatmap_paper.pdf"),
      width = 8, height = 6)
  print(
    DoHeatmap(mouse, features = genes_m, group.by = "celltype_final",
              slot = "scale.data", raster = TRUE, label = FALSE) +
      ggtitle(paste0("Mouse — Top", topN, " markers per cell type")) +
      theme_baron()
  )
  dev.off()
}
```
---

## 3. Fig2：donor × celltype 相关性热图（03\_fig2\_corr.R）

```r
############################################################
# 3. Fig2 — donor × cell type correlation heatmaps
############################################################

avg_by_donor_celltype <- function(obj,
                                  celltype_col = "celltype_final",
                                  assay = "RNA") {
  mat <- get_data(obj, assay = assay)
  md  <- obj@meta.data
  group <- paste(md$sample, md[[celltype_col]], sep = "_")
  groups <- unique(group)
  res_list <- lapply(groups, function(g) {
    cells <- colnames(mat)[group == g]
    if (length(cells) < 3) return(NULL)
    rowMeans(mat[, cells, drop = FALSE])
  })
  names(res_list) <- groups
  res_list <- res_list[!vapply(res_list, is.null, logical(1))]
  res_mat <- do.call(cbind, res_list)
  colnames(res_mat) <- names(res_list)
  res_mat
}
plot_corr_heatmap <- function(avg_mat, title = "", file = NULL){
  cormat <- cor(avg_mat, method = "pearson", use = "pairwise.complete.obs")
  tmp <- strsplit(colnames(cormat), "_")
  donor <- sapply(tmp, `[`, 1)
  ctype <- sapply(tmp, `[`, 2)
  anno  <- data.frame(donor = donor, celltype = ctype,
                      row.names = colnames(cormat))
  p <- pheatmap(cormat,
                clustering_method = "average",
                annotation_row = anno,
                annotation_col = anno,
                color = colorRampPalette(c("#4575B4","#E0F3F8",
                                           "#FFFFBF","#FEE090","#D73027"))(100),
                treeheight_row = 10, treeheight_col = 10,
                fontsize = 9, main = title)
  if (!is.null(file)) {
    pdf(file, width = 7, height = 6)
    print(p)
    dev.off()
  }
}
# ---- 3.1 Human Fig2B ----
if (!is.null(human)) {
  avg_h <- avg_by_donor_celltype(human)
  plot_corr_heatmap(avg_h,
                    "Human donor × cell type — Pearson correlation",
                    file = file.path(RESULTS_HUMAN, "Human_Fig2B_corr_heatmap.pdf"))
}
# ---- 3.2 Mouse Fig2C + Human+Mouse 合并 ----
if (!is.null(mouse)) {
  avg_m <- avg_by_donor_celltype(mouse)
  plot_corr_heatmap(avg_m,
                    "Mouse donor × cell type — Pearson correlation",
                    file = file.path(RESULTS_MOUSE, "Mouse_Fig2C_corr_heatmap.pdf"))

  if (!is.null(human)) {
    get_ct <- function(x) sapply(strsplit(colnames(x), "_"), `[`, 2)
    ct_h <- get_ct(avg_h)
    ct_m <- get_ct(avg_m)
    common_ct <- intersect(unique(ct_h), unique(ct_m))

    avg_h2 <- avg_h[, ct_h %in% common_ct, drop = FALSE]
    avg_m2 <- avg_m[, ct_m %in% common_ct, drop = FALSE]

    colnames(avg_h2) <- paste0("H_", colnames(avg_h2))
    colnames(avg_m2) <- paste0("M_", colnames(avg_m2))
    avg_all <- cbind(avg_h2, avg_m2)

    plot_corr_heatmap(avg_all,
                      "Human + Mouse common cell types — Pearson correlation",
                      file = file.path(RESULTS_MOUSE, "Mouse_Fig2D_HumanMouse_corr_heatmap.pdf"))
  }
}
```
---

## 4. Fig3：ductal PCA & PC1（03 / 04 脚本的一部分）

```r
############################################################
# 4. Fig3 — ductal PCA & PC1 (human & mouse)
############################################################

pca_for_celltype <- function(obj,
                             target_ct = "Ductal",
                             celltype_col = "celltype_final",
                             npcs = 30) {
  sub <- subset(obj, cells = rownames(obj@meta.data)[obj@meta.data[[celltype_col]] == target_ct])
  message(target_ct, " cells: ", ncol(sub))
  sub <- NormalizeData(sub, verbose = FALSE)
  sub <- FindVariableFeatures(sub, verbose = FALSE)
  sub <- ScaleData(sub, verbose = FALSE)
  sub <- RunPCA(sub, npcs = npcs, verbose = FALSE)
  sub
}

moving_average_along_pc1 <- function(obj, genes,
                                     n_bins = 30,
                                     assay = "RNA") {
  genes <- match_features(obj, genes)
  if (length(genes) == 0) {
    message("没有匹配到任何基因，跳过 moving average。")
    return(NULL)
  }
  pc1 <- Embeddings(obj, "pca")[, 1]
  data_mat <- get_data(obj, assay = assay)
  brks <- seq(min(pc1), max(pc1), length.out = n_bins + 1)
  bin_id <- cut(pc1, breaks = brks, include.lowest = TRUE, labels = FALSE)
  profiles <- lapply(genes, function(g) {
    tapply(as.numeric(data_mat[g, ]), bin_id, mean, na.rm = TRUE)
  })
  names(profiles) <- genes
  prof_df <- as.data.frame(profiles)
  prof_df$bin <- seq_len(nrow(prof_df))
  prof_long <- pivot_longer(prof_df, cols = all_of(genes),
                            names_to = "gene", values_to = "expr")
  prof_long
}

pc1_heatmap <- function(obj, top_n = 40,
                        assay = "RNA",
                        n_bins = 30,
                        title = "", file = NULL) {
  loadings <- Loadings(obj[["pca"]])[, 1]
  ord <- order(abs(loadings), decreasing = TRUE)[1:top_n]
  genes <- names(loadings)[ord]
  genes <- match_features(obj, genes)
  if (length(genes) == 0) {
    message("没有匹配到任何基因，跳过 PC1 热图。")
    return(invisible(NULL))
  }
  pc1 <- Embeddings(obj, "pca")[, 1]
  data_mat <- get_data(obj, assay = assay)
  brks <- seq(min(pc1), max(pc1), length.out = n_bins + 1)
  bin_id <- cut(pc1, breaks = brks, include.lowest = TRUE, labels = FALSE)
  prof_list <- lapply(genes, function(g) {
    tapply(as.numeric(data_mat[g, ]), bin_id, mean, na.rm = TRUE)
  })
  prof_mat <- do.call(cbind, prof_list)
  rownames(prof_mat) <- paste0("bin", seq_len(nrow(prof_mat)))
  colnames(prof_mat) <- genes
  prof_scaled <- t(scale(t(prof_mat)))

  p <- pheatmap(prof_scaled,
                cluster_rows = FALSE,
                cluster_cols = TRUE,
                main = title, fontsize = 8)
  if (!is.null(file)) {
    pdf(file, width = 6, height = 6)
    print(p)
    dev.off()
  }
}

# ---- 4.1 Human ductal (Fig3A/B/C) ----
duct_genes_h <- c("MUC1","CFTR","TFF1","TFF2","CD44","PLAT")

if (!is.null(human)) {
  duct_h <- pca_for_celltype(human, target_ct = "Ductal")

  # PCA PC1 vs PC2 coloured by sample
  pdf(file.path(RESULTS_HUMAN, "Human_Fig3A_Ductal_PCA_PC1_PC2.pdf"),
      width = 5, height = 5)
  print(
    DimPlot(duct_h, reduction = "pca", dims = c(1,2),
            group.by = "sample") +
      ggtitle("Human ductal — PCA (PC1 vs PC2, coloured by sample)") +
      theme_baron()
  )
  dev.off()

  # PCA 上按 ductal markers 着色
  duct_genes_h <- match_features(duct_h, duct_genes_h)
  pdf(file.path(RESULTS_HUMAN, "Human_Fig3C_dutcal_PCA_markers.pdf"),
      width = 7, height = 5)
  p_list_duct <- lapply(duct_genes_h, function(g){
    FeaturePlot(duct_h, features = g, reduction = "pca",
                dims = c(1,2), pt.size = 0.5) +
      ggtitle(g) + theme_baron()
  })
  print(wrap_plots(p_list_duct, ncol = 3))
  dev.off()

  # PC1 moving average + loading heatmap
  ma_duct <- moving_average_along_pc1(duct_h, duct_genes_h, n_bins = 30)
  if (!is.null(ma_duct)) {
    pdf(file.path(RESULTS_HUMAN, "Human_Fig3B_Ductal_PC1_Markers_MA.pdf"),
        width = 7, height = 5)
    print(
      ggplot(ma_duct, aes(x = bin, y = expr)) +
        geom_line(color = "firebrick", linewidth = 0.7) +
        facet_wrap(~ gene, scales = "free_y", ncol = 3) +
        labs(x = "PC1 bin", y = "Mean log-normalized expression",
             title = "Human ductal — moving average along PC1") +
        theme_baron()
    )
    dev.off()
  }

  pc1_heatmap(duct_h, top_n = 40,
              title = "Human ductal — genes with high PC1 loading",
              file  = file.path(RESULTS_HUMAN, "Human_Fig3D_Ductal_PC1_loading_heatmap.pdf"))
}

# ---- 4.2 Mouse ductal (Fig3A/B/C for mouse) ----
duct_genes_m <- c("Muc1","Cftr","Tff1","Tff2","Cd44","Plat")

if (!is.null(mouse)) {
  duct_m <- pca_for_celltype(mouse, target_ct = "Ductal")

  pdf(file.path(RESULTS_MOUSE, "Mouse_Fig3A_Ductal_PCA_PC1_PC2.pdf"),
      width = 5, height = 5)
  print(
    DimPlot(duct_m, reduction = "pca", dims = c(1,2),
            group.by = "sample") +
      ggtitle("Mouse ductal — PCA (PC1 vs PC2, coloured by sample)") +
      theme_baron()
  )
  dev.off()

  duct_genes_m <- match_features(duct_m, duct_genes_m)
  pdf(file.path(RESULTS_MOUSE, "Mouse_Fig3C_Ductal_PCA_markers.pdf"),
      width = 7, height = 5)
  p_list_duct_m <- lapply(duct_genes_m, function(g){
    FeaturePlot(duct_m, features = g, reduction = "pca",
                dims = c(1,2), pt.size = 0.5) +
      ggtitle(g) + theme_baron()
  })
  print(wrap_plots(p_list_duct_m, ncol = 3))
  dev.off()

  ma_duct_m <- moving_average_along_pc1(duct_m, duct_genes_m, n_bins = 30)
  if (!is.null(ma_duct_m)) {
    pdf(file.path(RESULTS_MOUSE, "Mouse_Fig3B_Ductal_PC1_Markers_MA.pdf"),
        width = 7, height = 5)
    print(
      ggplot(ma_duct_m, aes(x = bin, y = expr)) +
        geom_line(color = "steelblue4", linewidth = 0.7) +
        facet_wrap(~ gene, scales = "free_y", ncol = 3) +
        labs(x = "PC1 bin", y = "Mean log-normalized expression",
             title = "Mouse ductal — moving average along PC1") +
        theme_baron()
    )
    dev.off()
  }

  pc1_heatmap(duct_m, top_n = 40,
              title = "Mouse ductal — genes with high PC1 loading",
              file  = file.path(RESULTS_MOUSE, "Mouse_Fig3D_Ductal_PC1_loading_heatmap.pdf"))
}
```

---

## 5. Fig4：Beta 细胞 PCA / PC1（04\_fig3\_ductal\_fig4\_beta\_PCA.R 的 Beta 部分）

```r
############################################################
# 5. Fig4 — Beta cell PCA / PC1 (human & mouse)
############################################################

beta_genes_h <- c("HSPA5","MAFA","HERPUD1","DDIT3","UCN3")

if (!is.null(human)) {
  beta_h <- subset(human,
                   subset = celltype_final == "Beta" & nCount_RNA >= 3000)
  beta_h <- NormalizeData(beta_h, verbose = FALSE)
  beta_h <- FindVariableFeatures(beta_h, verbose = FALSE)
  beta_h <- ScaleData(beta_h, verbose = FALSE)
  beta_h <- RunPCA(beta_h, npcs = 30, verbose = FALSE)

  # PCA coloured by nCount_RNA
  pdf(file.path(RESULTS_HUMAN, "Human_Fig4A_Beta_PCA_PC1_PC2_nCount.pdf"),
      width = 5, height = 5)
  print(
    FeaturePlot(beta_h, features = "nCount_RNA",
                reduction = "pca", dims = c(1,2)) +
      ggtitle("Human Beta — PCA coloured by nCount_RNA") +
      theme_baron()
  )
  dev.off()

  beta_genes_h <- match_features(beta_h, beta_genes_h)
  ma_beta <- moving_average_along_pc1(beta_h, beta_genes_h, n_bins = 30)
  if (!is.null(ma_beta)) {
    pdf(file.path(RESULTS_HUMAN, "Human_Fig4B_Beta_PC1_Markers_MA.pdf"),
        width = 8, height = 4)
    print(
      ggplot(ma_beta, aes(x = bin, y = expr)) +
        geom_line(color = "steelblue4", linewidth = 0.7) +
        facet_wrap(~ gene, scales = "free_y", ncol = 5) +
        labs(x = "PC1 bin", y = "Mean log-normalized expression",
             title = "Human Beta — moving average along PC1") +
        theme_baron()
    )
    dev.off()
  }
}

beta_genes_m <- c("Hspa5","Mafa","Herpud1","Ddit3","Ucn3")

if (!is.null(mouse)) {
  beta_m <- subset(mouse,
                   subset = celltype_final == "Beta" & nCount_RNA >= 3000)
  beta_m <- NormalizeData(beta_m, verbose = FALSE)
  beta_m <- FindVariableFeatures(beta_m, verbose = FALSE)
  beta_m <- ScaleData(beta_m, verbose = FALSE)
  beta_m <- RunPCA(beta_m, npcs = 30, verbose = FALSE)

  pdf(file.path(RESULTS_MOUSE, "Mouse_Fig4A_Beta_PCA_PC1_PC2_nCount.pdf"),
      width = 5, height = 5)
  print(
    FeaturePlot(beta_m, features = "nCount_RNA",
                reduction = "pca", dims = c(1,2)) +
      ggtitle("Mouse Beta — PCA coloured by nCount_RNA") +
      theme_baron()
  )
  dev.off()

  beta_genes_m <- match_features(beta_m, beta_genes_m)
  ma_beta_m <- moving_average_along_pc1(beta_m, beta_genes_m, n_bins = 30)
  if (!is.null(ma_beta_m)) {
    pdf(file.path(RESULTS_MOUSE, "Mouse_Fig4B_Beta_PC1_Markers_MA.pdf"),
        width = 8, height = 4)
    print(
      ggplot(ma_beta_m, aes(x = bin, y = expr)) +
        geom_line(color = "firebrick", linewidth = 0.7) +
        facet_wrap(~ gene, scales = "free_y", ncol = 5) +
        labs(x = "PC1 bin", y = "Mean log-normalized expression",
             title = "Mouse Beta — moving average along PC1") +
        theme_baron()
    )
    dev.off()
  }
}

message("✅ Baron 2016 Human & Mouse pancreas: Fig1–4 脚本全部运行完成。")
```
